<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Chiese Aperte – Scheda POI</title>

  <!-- Puoi tenerlo: qui sotto sovrascriviamo solo ciò che serve alla scheda -->
  <link rel="stylesheet" href="style.css" />

  <style>
  /* =========================
    VARIABILI
    ========================= */
  :root{
    --header-pad: 8px;

    --title-h: 52px;
    --poi-bar-h: 74px;

    --footer-h: 52px;

    --strip-bg: #ec674d; /* colore barra Percorso (override via JS) */
    --content-max-w: 720px; /* larghezza max contenuto (centro) */
  }

  /* =========================
    BASE
    ========================= */
  html, body{ height: 100%; }

  body{
    margin: 0;
    overflow: hidden; /* scroll SOLO nel main */
    background: #f0dabb;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    color: #222;
  }

  /* =========================
    HEADER FISSO
    ========================= */
  .scheda-header{
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 3000;
    padding: var(--header-pad);
    pointer-events: none;
  }

  .header-title-wrap{
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: space-between;
    width: 100%;
    pointer-events: none;
  }

  .header-actions{
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 8px;
    pointer-events: auto;
  }

  .home-btn{
    border: none;
    background: transparent;
    color: #222;
    padding: 4px 6px;
    border-radius: 10px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 38px;
    pointer-events: auto;
  }

  .home-btn img{
    width: 38px;
    height: 38px;
    display: block;
  }

  .header-title{
    max-height: var(--title-h);
    width: auto;
    display: block;
    pointer-events: auto;
  }

  /* Fascia POI */
  .poi-bar{
    margin-top: 0;
    background: #fff;
    padding: 8px 12px;
    display: flex;
      gap: 6px;
    align-items: flex-end;
    box-shadow: none;
    pointer-events: auto;
  }

  .poi-icon{
    height: 58px;
    width: auto;
    display: block;
  }

  .poi-name{
    font-size: 19px;
    font-weight: 700;
    line-height: 1.1;
  }

  .lang-toggle{
    margin-left: auto;
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .lang-btn{
    border: 1px solid #222;
    background: transparent;
    color: #222;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.4px;
    padding: 4px 8px;
    border-radius: 12px;
    cursor: pointer;
  }

  .lang-btn.is-active{
    background: #222;
    color: #fff;
  }

  /* =========================
    FOOTER FISSO
    ========================= */
  .footer{
    position: fixed;
    left: 8px;
    right: 8px;
    bottom: 0;
    height: var(--footer-h);
    padding-bottom: env(safe-area-inset-bottom);
    z-index: 3000;
    display: flex;
    align-items: flex-end;
  }

  .footer-logos{
    display: flex;
    gap: 12px;
    align-items: flex-end;
  }

  .footer-logo{
    height: 30px;
    width: auto;
  }

  .footer-banner{
    margin-left: auto;
    height: 36px;
    width: auto;
  }

  /* =========================
    MAIN SCORREVOLE (centro)
    ========================= */
  .scheda-main{
    position: fixed;
    left: 8px;
    right: 8px;
    top: calc(var(--header-pad) + var(--title-h) + var(--poi-bar-h) + 6px);
    bottom: calc(var(--footer-h) + env(safe-area-inset-bottom));
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
  }

  /* Contenuto centrato e allineato */
  .content-grid{
    max-width: var(--content-max-w);
    margin: 0 auto;             /* ✅ centra orizzontalmente */
    display: flex;
    flex-direction: column;      /* ✅ SEMPRE colonna */
      gap: 2px;
    padding: 8px 0 12px;
    width: 100%;
  }

  /* =========================
    IMMAGINE (proporzioni corrette)
    ========================= */
  .media{
    display: flex;
    justify-content: center;  /* centra l’immagine */
    align-items: center;
  }

  .media img{
    width: 100%;
    height: auto;
    display: block;
    object-fit: contain;      /* ✅ niente tagli */
    max-height: 42vh;         /* evita che “mangi” tutto in landscape */
  }

  /* =========================
    TESTO
    ========================= */
  .text{
    background: #432813;
    color: #fff;
    padding: 12px 20px;
  }

  .poi-text{
    margin: 0;
    font-size: 18px;
    line-height: 1.45;
    white-space: pre-wrap;
    text-align: justify;
    text-justify: inter-word;
  }

  /* =========================
    BARRA AZIONI (Percorso)
    ========================= */
  .bottom-strip{
    background: var(--strip-bg);
    padding: 12px 12px;
    padding-left: 8px;
    display: flex;
    align-items: center;
    justify-content: flex-start; /* pulsante a sinistra */
    gap: 12px;               /* pronta per altri tasti */
    overflow: hidden;
  }

  .percorso-btn{
    border: 0;
    background: transparent;
    padding: 0;
    cursor: pointer;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 0 0 auto;
  }

  .percorso-btn img{
    height: 100%;
    width: auto;
    display: block;
    object-fit: contain;
    -webkit-user-drag: none;
    user-select: none;
  }

  .preview-strip{
    display: flex;
    align-items: center;
    gap: 8px;
    overflow-x: auto;
    overflow-y: hidden;
    padding: 6px 0;
    flex: 1 1 auto;
    width: 100%;
    scroll-behavior: smooth;
    min-width: 0;
    max-width: 100%;
  }

  .preview-strip-wrap{
    position: relative;
    flex: 1 1 0%;
    min-width: 0;
    display: flex;
  }

  .preview-strip-wrap::before,
  .preview-strip-wrap::after{
    content: "";
    position: absolute;
    top: 0;
    bottom: 0;
    width: 18px;
    pointer-events: none;
    opacity: 0;
  }

  .preview-strip-wrap::before{
    left: 0;
    background: linear-gradient(to right, var(--strip-bg) 0%, transparent 100%);
  }

  .preview-strip-wrap::after{
    right: 0;
    background: linear-gradient(to left, var(--strip-bg) 0%, transparent 100%);
  }

  .preview-strip-wrap.has-overflow::before,
  .preview-strip-wrap.has-overflow::after{
    opacity: 1;
  }
  .preview-strip::-webkit-scrollbar{
    height: 6px;
  }

  .preview-btn{
    border: 0;
    background: transparent;
    padding: 0;
    cursor: pointer;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 0 0 auto;
  }

  .preview-btn img{
    height: 100%;
    width: auto;
    display: block;
    object-fit: contain;
    -webkit-user-drag: none;
    user-select: none;
  }

  .overlay{
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 4000;
    padding: 20px;
  }

  .overlay.is-visible{
    display: flex;
  }

  .overlay img{
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
  }

  .overlay-close{
    position: absolute;
    top: 14px;
    right: 14px;
    width: 40px;
    height: 40px;
    border: 0;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.9);
    color: #111;
    font-size: 24px;
    line-height: 40px;
    text-align: center;
    cursor: pointer;
  }

  /* =========================
    LANDSCAPE:
    ========================= */
  @media (orientation: landscape){
    :root{
      --title-h: 46px;
      --poi-bar-h: 62px;
    }

    .media img{
      max-height: 55vh; /* in landscape puoi farla un po’ più alta */
    }

    .poi-text{
      font-size: 16px;
    }
  }

  /* Smartphone: titolo un po' piu' piccolo */
  @media (max-width: 480px){
    :root{
      --title-h: 40px;
    }
  }
  </style>



</head>

<body>
  <!-- HEADER fisso -->
  <header class="scheda-header" aria-label="Header scheda">
    <div class="header-title-wrap">
      <button class="home-btn" type="button" id="btnHome" aria-label="Home">
        <img src="immagini/PulsanteHome.png" alt="" aria-hidden="true" />
      </button>
      <img
        src="immagini/Titolo_ChieseAperte.png"
        class="header-title"
        alt="Chiese Aperte"
        id="titolo-app"
      />
    </div>

    <section class="poi-bar" aria-label="POI selezionato">
      <img id="poiIcona" class="poi-icon" alt="Icona POI" />
      <div id="poiNome" class="poi-name">Caricamento...</div>
      <div class="lang-toggle" role="group" aria-label="Lingua">
        <button class="lang-btn is-active" type="button" data-lang="it" aria-pressed="true">IT</button>
        <button class="lang-btn" type="button" data-lang="en" aria-pressed="false">EN</button>
      </div>
    </section>
  </header>

  <!-- MAIN scorrevole (unico scroll) -->
  <main class="scheda-main" aria-label="Contenuto scheda">
    <section class="content-grid" aria-label="Immagine e testo">
      <!-- Immagine -->
      <div class="media" aria-label="Immagine principale">
        <img id="poiFoto" alt="Immagine POI" />
      </div>

      <section class="content-grid">

        <div class="media">
          <img id="poiFoto" />
        </div>

        <div class="text">
          <p id="poiDescrizione" class="poi-text"></p>
        </div>

        <!-- ✅ Barra azioni FUORI dal testo -->
        <div class="bottom-strip" id="bottomStrip">
          <button id="btnPercorso" class="percorso-btn" type="button">
            <img id="poiPercorsoImg" alt="Percorso" />
          </button>
          <div class="preview-strip-wrap" id="previewStripWrap" aria-hidden="true">
            <div class="preview-strip" id="previewStrip" aria-label="Anteprime"></div>
          </div>
        </div>

      </section>

    </section>
  </main>

  <div class="overlay" id="imageOverlay" aria-hidden="true">
    <img id="overlayImage" alt="Foto in primo piano" />
    <button type="button" class="overlay-close" id="overlayClose" aria-label="Chiudi">×</button>
  </div>

  <!-- FOOTER fisso -->
  <footer class="footer" id="appFooter" aria-label="Footer">
    <div class="footer-logos">
      <img src="immagini/Logo3.png" alt="Logo 3" class="footer-logo" />
      <img src="immagini/Logo2.png" alt="Logo 2" class="footer-logo" />
      <img src="immagini/Logo1.png" alt="Logo 1" class="footer-logo" />
    </div>
    <img src="immagini/Footer.png" alt="Footer decorativo" class="footer-banner" />
  </footer>

  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');

    const poiIconaEl = document.getElementById('poiIcona');
    const poiNomeEl = document.getElementById('poiNome');
    const poiFotoEl = document.getElementById('poiFoto');
    const poiDescrizioneEl = document.getElementById('poiDescrizione');

    const bottomStrip = document.getElementById('bottomStrip');
    const btnPercorso = document.getElementById('btnPercorso');
    const poiPercorsoImg = document.getElementById('poiPercorsoImg');
    const previewStrip = document.getElementById('previewStrip');
    const previewStripWrap = document.getElementById('previewStripWrap');
    const imageOverlay = document.getElementById('imageOverlay');
    const overlayImage = document.getElementById('overlayImage');
    const overlayClose = document.getElementById('overlayClose');
    const langButtons = document.querySelectorAll('.lang-btn');
    const langToggle = document.querySelector('.lang-toggle');
    const btnHome = document.getElementById('btnHome');
    let currentPoi = null;
    let currentLang = 'it';

    function updatePreviewOverflow(){
      if (!previewStrip || !previewStripWrap) return;
      const hasOverflow = previewStrip.scrollWidth > previewStrip.clientWidth + 1;
      previewStripWrap.classList.toggle('has-overflow', hasOverflow);
    }

    function resetUI(msg){
      if (poiNomeEl) {
        poiNomeEl.textContent = msg || '';
        poiNomeEl.style.color = '#222';
      }
      if (poiIconaEl) poiIconaEl.style.display = 'none';
      if (poiFotoEl) poiFotoEl.style.display = 'none';
      if (poiDescrizioneEl) poiDescrizioneEl.textContent = '';

      if (bottomStrip) bottomStrip.style.display = 'none';
      if (btnPercorso) btnPercorso.style.display = 'none';
      if (previewStrip) previewStrip.style.display = 'none';
      if (imageOverlay) imageOverlay.classList.remove('is-visible');
      if (langToggle) langToggle.style.display = 'none';
    }

    function resolveTestoPath(poi, lang){
      if (!poi) return '';
      if (lang === 'en' && poi.testo_en) return poi.testo_en;
      return poi.testo || '';
    }

    function caricaTestoDaFile(poi, lang){
      if (!poiDescrizioneEl) return;

      const testoPath = resolveTestoPath(poi, lang);
      if (!testoPath) {
        poiDescrizioneEl.textContent = poi.descrizione || '';
        return;
      }

      poiDescrizioneEl.textContent = 'Caricamento...';

      fetch(testoPath + '?nocache=' + Date.now())
        .then(r => {
          if (!r.ok) throw new Error('Impossibile caricare: ' + testoPath);
          return r.text();
        })
        .then(txt => {
          poiDescrizioneEl.textContent = txt;
        })
        .catch(err => {
          console.error('Errore caricamento testo:', err);
          poiDescrizioneEl.textContent = poi.descrizione || 'Testo non disponibile.';
        });
    }

    function setLanguage(lang, poi){
      currentLang = (lang === 'en') ? 'en' : 'it';
      document.documentElement.setAttribute('lang', currentLang);
      if (langButtons && langButtons.length > 0) {
        langButtons.forEach(btn => {
          const isActive = btn.dataset.lang === currentLang;
          btn.classList.toggle('is-active', isActive);
          btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
      }
      try {
        localStorage.setItem('poiLang', currentLang);
      } catch (err) {
        console.warn('Impossibile salvare lingua:', err);
      }
      if (poi) caricaTestoDaFile(poi, currentLang);
    }

    function getInitialLang(){
      const fromQuery = params.get('lang');
      const fromStorage = (() => {
        try {
          return localStorage.getItem('poiLang');
        } catch (err) {
          return null;
        }
      })();
      const candidate = (fromQuery || fromStorage || 'it').toLowerCase();
      return candidate === 'en' ? 'en' : 'it';
    }

    if (langButtons && langButtons.length > 0) {
      langButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          if (!currentPoi) return;
          setLanguage(btn.dataset.lang, currentPoi);
        });
      });
    }

    if (btnHome) {
      btnHome.addEventListener('click', () => {
        window.location.href = 'index.html';
      });
    }

    if (!id) {
      resetUI('POI non specificato');
    } else {
      fetch('pois.json?nocache=' + Date.now())
        .then(res => res.json())
        .then(punti => {
          const poi = punti.find(p => p.id === id);
          if (!poi) {
            resetUI('POI non trovato');
            return;
          }
          currentPoi = poi;
          if (langToggle) langToggle.style.display = 'flex';

          // Nome + colore
          if (poiNomeEl) {
            poiNomeEl.textContent = poi.nome || '';
            poiNomeEl.style.color = poi.colore || '#222';
          }

          // Icona POI
          if (poiIconaEl && poi.iconapoi) {
            poiIconaEl.src = poi.iconapoi;
            poiIconaEl.style.display = 'block';
          } else if (poiIconaEl) {
            poiIconaEl.style.display = 'none';
          }

          // Immagine principale
          if (poiFotoEl && poi.immagine) {
            poiFotoEl.src = poi.immagine;
            poiFotoEl.style.display = 'block';
          } else if (poiFotoEl) {
            poiFotoEl.style.display = 'none';
          }

          // Testo lungo (da file esterno)
          setLanguage(getInitialLang(), poi);

          // Barra percorso colorata (dentro contenuto scorrevole)
          const tema = poi.colore || '#ec674d';
          if (bottomStrip) {
            bottomStrip.style.background = tema;
          }

          // Bottone percorso (immagine) + Google Maps a piedi
          if (btnPercorso && poiPercorsoImg && poi.imgpercorso && poi.lat && poi.lng) {
            poiPercorsoImg.src = poi.imgpercorso;
            btnPercorso.style.display = 'flex';
            if (bottomStrip) bottomStrip.style.display = 'flex';

            btnPercorso.onclick = () => {
              const dest = `${poi.lat},${poi.lng}`;
              const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}&travelmode=walking`;
              window.open(url, '_blank');
            };
          } else {
            if (bottomStrip) bottomStrip.style.display = 'none';
            if (btnPercorso) btnPercorso.style.display = 'none';
          }

          if (previewStrip) {
            previewStrip.innerHTML = '';
            const totalFoto = parseInt(poi.numerofoto, 10);
            if (poi.percorsofoto && Number.isFinite(totalFoto) && totalFoto > 0) {
              for (let i = 1; i <= totalFoto; i += 1) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'preview-btn';

                const img = document.createElement('img');
                img.alt = `Anteprima ${i}`;
                img.src = `${poi.percorsofoto}Anteprima${i}.png`;
                img.addEventListener('load', updatePreviewOverflow);

                btn.appendChild(img);
                btn.addEventListener('click', () => {
                  if (!imageOverlay || !overlayImage) return;
                  overlayImage.src = `${poi.percorsofoto}foto${i}.png`;
                  imageOverlay.classList.add('is-visible');
                  imageOverlay.setAttribute('aria-hidden', 'false');
                });
                previewStrip.appendChild(btn);
              }
              previewStrip.style.display = 'flex';
              requestAnimationFrame(updatePreviewOverflow);
            } else {
              previewStrip.style.display = 'none';
            }
          }
        })
        .catch(err => {
          console.error('Errore caricamento pois.json:', err);
          resetUI('Errore nel caricamento');
        });
    }

    function closeOverlay(){
      if (!imageOverlay) return;
      imageOverlay.classList.remove('is-visible');
      imageOverlay.setAttribute('aria-hidden', 'true');
      if (overlayImage) overlayImage.src = '';
    }

    if (imageOverlay) {
      imageOverlay.addEventListener('click', (event) => {
        if (event.target !== imageOverlay) return;
        closeOverlay();
      });
    }

    if (overlayClose) {
      overlayClose.addEventListener('click', () => {
        closeOverlay();
      });
    }

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') return;
      closeOverlay();
    });

    if (imageOverlay) {
      let touchStartY = null;
      imageOverlay.addEventListener('touchstart', (event) => {
        if (!event.touches || event.touches.length === 0) return;
        touchStartY = event.touches[0].clientY;
      }, { passive: true });

      imageOverlay.addEventListener('touchend', (event) => {
        if (touchStartY === null) return;
        const endTouch = event.changedTouches && event.changedTouches[0];
        if (!endTouch) return;
        const deltaY = endTouch.clientY - touchStartY;
        touchStartY = null;
        if (Math.abs(deltaY) > 80) {
          closeOverlay();
        }
      }, { passive: true });
    }

    window.addEventListener('resize', updatePreviewOverflow);
  </script>
</body>
</html>
