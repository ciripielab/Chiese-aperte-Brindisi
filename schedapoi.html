<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Chiese Aperte – Scheda POI</title>

  <link rel="stylesheet" href="style.css" />

  <style>
    :root{
      /* Header POI (fascia bianca) */
      --poi-icon-h: 58px;
      --poi-name-size: 19px;
      --poi-pad-v: 6px;
      --poi-pad-r: 10px;
      --poi-pad-l: 14px;

      /* Barra in basso sezione testo */
      --strip-h: 100px;
      --strip-bg: #ec674d; /* fallback, puoi sovrascriverlo via JS con poi.colore */
    }

    /* Titolo in alto a destra */
    .scheda-title{
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 1100;
      display: flex;
      justify-content: flex-end;
      pointer-events: none;
    }
    .scheda-title .header-title{
      pointer-events: auto;
      display: block;
    }

    /* Fascia bianca (Sezione 1) */
    .poi-header{
      position: absolute;
      left: 8px;
      right: 8px;
      z-index: 1100;

      background: #ffffff;
      border-radius: 0;
      padding: var(--poi-pad-v) var(--poi-pad-r) var(--poi-pad-v) var(--poi-pad-l);
      box-shadow: 0 1px 3px rgba(0,0,0,0.10);
    }

    .poi-header-right{
      display: flex;
      align-items: flex-end;
      justify-content: flex-start;
      gap: 8px;
    }

    .poi-header img{
      height: var(--poi-icon-h);
      width: auto;
      display: block;
    }

    .poi-header .poi-name{
      font-weight: 700;
      font-size: var(--poi-name-size);
      line-height: 1.15;
      text-align: left;
      color: #222; /* sovrascritto via JS con poi.colore */
    }

    /* Contenuto (Sezione 2 + 3): top impostato via JS */
    .scheda-content{
      position: absolute;
      left: 8px;
      right: 8px;
      bottom: calc(var(--footer-h) + env(safe-area-inset-bottom));
      z-index: 1000;

      display: flex;
      flex-direction: column; /* portrait default */
      gap: 10px;

      overflow: hidden;
      -webkit-overflow-scrolling: touch;
    }

    /* Sezioni 2 e 3: stessa altezza disponibile */
    .sezione-immagine,
    .sezione-descrizione{
      flex: 1 1 0;
      min-height: 0;
    }

    /* Sezione 2: foto grande */
    .sezione-immagine{
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
    }

    .sezione-immagine img{
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover; /* cambia in contain se vuoi vederla tutta senza tagli */
      max-height: none;
    }

    /* Sezione 3: testo + barra */
    .sezione-descrizione{
      background: #432813;
      border-radius: 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);

      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    /* Testo scrollabile */
    .descrizione-box{
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 24px 22px;
    }

    .descrizione-box p{
      margin: 0;
      font-size: 15px;
      line-height: 1.45;
      color: #ffffff;
    }

    #poiDescrizione{
      white-space: pre-wrap;
      text-align: justify;     /* testo giustificato */
      text-justify: inter-word;
    }

    /* Barra in basso (solo bottone percorso) */
    .bottom-strip{
      flex: 0 0 var(--strip-h);
      height: var(--strip-h);

      display: flex;
      align-items: center;
      justify-content: flex-start;

      padding: 10px;
      background: var(--strip-bg);
      box-sizing: border-box;
    }

    /* Bottone percorso: niente riquadri, immagine centrata */
    .percorso-btn{
      border: 0;
      background: transparent;
      padding: 0;
      cursor: pointer;

      display: flex;
      align-items: center;
      justify-content: center;

      height: 100%;         /* prende altezza della barra */
      max-height: 100%;
    }

    .percorso-btn img{
      height: 100%;         /* l’immagine riempie in altezza */
      width: auto;          /* mantiene proporzioni */
      display: block;
      object-fit: contain;

      -webkit-user-drag: none;
      user-select: none;
    }

    /* LANDSCAPE: foto a sinistra, testo a destra */
    @media (orientation: landscape){
      :root{
        --poi-icon-h: 52px;
        --poi-name-size: 18px;
        --poi-pad-v: 5px;
        --strip-h: 100px;
      }

      .scheda-content{
        flex-direction: row;
        align-items: stretch;
      }
    }

    /* Piccoli schermi: riduci un filo la barra */
    @media (max-width: 420px){
      :root{
        --strip-h: 88px;
      }
    }
  </style>


</head>

<body>
  <div class="page">

    <!-- Titolo -->
    <div class="scheda-title">
      <img
        src="immagini/Titolo_ChieseAperte.png"
        alt="Chiese Aperte"
        class="header-title"
        id="titolo-app"
      />
    </div>

    <!-- Sezione 1: fascia bianca -->
    <section class="poi-header" aria-label="Intestazione POI" id="poiHeader">
      <div class="poi-header-right">
        <img id="poiIcona" alt="Icona POI" />
        <div id="poiNome" class="poi-name">Caricamento...</div>
      </div>
    </section>

    <!-- Sezione 2 + 3: subito sotto fascia -->
    <main class="scheda-content" id="schedaContent">

      <!-- Sezione 2: immagine -->
      <section class="sezione-immagine" aria-label="Immagine del POI">
        <img id="poiFoto" alt="Immagine POI" />
      </section>

      <!-- Sezione 3: descrizione + barra in basso -->
      <section class="sezione-descrizione" aria-label="Descrizione e Percorso del POI">
        <!-- TESTO (scrollabile) -->
        <div class="descrizione-box">
          <p id="poiDescrizione"></p>
        </div>

        <!-- BARRA IN BASSO (percorso + galleria) -->
        <div class="bottom-strip" id="bottomStrip">
          <button id="btnPercorso" class="percorso-btn" type="button">
            <img id="poiPercorsoImg" alt="Percorso" />
          </button>

          <div class="gallery" id="poiGallery" aria-label="Galleria immagini"></div>
        </div>
      </section>



    </main>

    <!-- Footer identico a index -->
    <footer class="footer" id="appFooter">
      <div class="footer-logos">
        <img src="immagini/Logo3.png" alt="Logo 3" class="footer-logo" />
        <img src="immagini/Logo2.png" alt="Logo 2" class="footer-logo" />
        <img src="immagini/Logo1.png" alt="Logo 1" class="footer-logo" />
      </div>
      <img src="immagini/Footer.png" alt="Footer decorativo" class="footer-banner" />
    </footer>

  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');

    const titoloEl = document.getElementById('titolo-app');
    const fasciaEl = document.getElementById('poiHeader');
    const contentEl = document.getElementById('schedaContent');

    const poiIconaEl = document.getElementById('poiIcona');
    const poiNomeEl = document.getElementById('poiNome');
    const poiFotoEl = document.getElementById('poiFoto');
    const poiDescrizioneEl = document.getElementById('poiDescrizione');

    const bottomStrip = document.getElementById('bottomStrip');
    const btnPercorso = document.getElementById('btnPercorso');
    const poiPercorsoImg = document.getElementById('poiPercorsoImg');

    const footerEl = document.getElementById('appFooter');


    function posizionaFasciaEContenuto() {
      if (!titoloEl || !fasciaEl || !contentEl) return;

      const topTitolo = 8;
      const hTitolo = titoloEl.getBoundingClientRect().height;

      // fascia attaccata al titolo
      const fasciaTop = topTitolo + hTitolo - 2;
      fasciaEl.style.top = fasciaTop + 'px';

      // contenuto attaccato alla fascia
      const hFascia = fasciaEl.getBoundingClientRect().height;
      const contentTop = fasciaTop + hFascia - 1;
      contentEl.style.top = contentTop + 'px';

      // ✅ calcolo footer reale (evita sovrapposizioni)
      const footerH = footerEl ? footerEl.getBoundingClientRect().height : 0;

      // 2px di “respiro” per evitare contatto
      contentEl.style.bottom = (footerH + 2) + 'px';
    }


    window.addEventListener('load', posizionaFasciaEContenuto);
    window.addEventListener('resize', posizionaFasciaEContenuto);

    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', posizionaFasciaEContenuto);
      window.visualViewport.addEventListener('scroll', posizionaFasciaEContenuto);
    }


    function resetUI(messaggio) {
      if (poiNomeEl) {
        poiNomeEl.textContent = messaggio || '';
        poiNomeEl.style.color = '#222';
      }
      if (poiIconaEl) poiIconaEl.style.display = 'none';
      if (poiFotoEl) poiFotoEl.style.display = 'none';
      if (poiDescrizioneEl) poiDescrizioneEl.textContent = '';

      if (bottomStrip) bottomStrip.style.display = 'none';
      if (btnPercorso) btnPercorso.style.display = 'none';
    }

    function caricaTestoDaFile(poi) {
      // Se non c'è campo "testo", fallback su descrizione
      if (!poiDescrizioneEl) return;

      if (!poi.testo) {
        poiDescrizioneEl.textContent = poi.descrizione || '';
        return;
      }

      poiDescrizioneEl.textContent = 'Caricamento...';

      fetch(poi.testo + '?nocache=' + Date.now())
        .then(r => {
          if (!r.ok) throw new Error('Impossibile caricare: ' + poi.testo);
          return r.text();
        })
        .then(txt => {
          poiDescrizioneEl.textContent = txt;
          requestAnimationFrame(posizionaFasciaEContenuto);
        })
        .catch(err => {
          console.error('Errore caricamento testo:', err);
          // fallback: descrizione breve dal json
          poiDescrizioneEl.textContent = poi.descrizione || 'Testo non disponibile.';
        });
    }

    if (!id) {
      resetUI('POI non specificato');
    } else {
      fetch('pois.json?nocache=' + Date.now())
        .then(res => res.json())
        .then(punti => {
          const poi = punti.find(p => p.id === id);

          if (!poi) {
            resetUI('POI non trovato');
            return;
          }

          // Sezione 1: nome + colore + icona
          if (poiNomeEl) {
            poiNomeEl.textContent = poi.nome || '';
            poiNomeEl.style.color = poi.colore || '#222';
          }

          if (poiIconaEl) {
            if (poi.iconapoi) {
              poiIconaEl.src = poi.iconapoi;
              poiIconaEl.style.display = 'block';
            } else {
              poiIconaEl.style.display = 'none';
            }
          }

          // Sezione 2: immagine principale
          if (poiFotoEl) {
            if (poi.immagine) {
              poiFotoEl.src = poi.immagine;
              poiFotoEl.style.display = 'block';
              poiFotoEl.onload = () => posizionaFasciaEContenuto();
            } else {
              poiFotoEl.style.display = 'none';
            }
          }

          // Sezione 3: testo da file esterno (fallback su descrizione)
          caricaTestoDaFile(poi);

          // Barra in basso: visibile + colore tema
          const tema = poi.colore || '#ec674d';
          if (bottomStrip) {
            bottomStrip.style.display = 'flex';
            bottomStrip.style.background = tema;
          }

          // Bottone percorso (immagine) + click -> Google Maps a piedi
          if (btnPercorso && poiPercorsoImg && poi.imgpercorso) {
            btnPercorso.style.display = 'flex';
            poiPercorsoImg.src = poi.imgpercorso;

            btnPercorso.onclick = () => {
              const dest = `${poi.lat},${poi.lng}`;
              const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}&travelmode=walking`;
              window.open(url, '_blank');
            };
          } else if (btnPercorso) {
            btnPercorso.style.display = 'none';
          }

          requestAnimationFrame(posizionaFasciaEContenuto);
        })
        .catch(err => {
          console.error('Errore caricamento pois.json:', err);
          resetUI('Errore nel caricamento');
        });
    }
  </script>

</body>
</html>
